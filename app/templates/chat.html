{% extends "base.html" %}

{% block title %}
Discover AI | TrustVest
{% endblock %}

{% block body %}
<style>
    /* Added to override background image default from base.html */
    body {
        background: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)),
            url("{{ url_for('static', filename='img/body_background.png') }}") no-repeat center center fixed;
        background-size: cover !important;
    }
</style>
<div class="chat-container">
    <div id="chat-box">
        <h2>Discover More (Powered by: Ollama)</h2>
        <h3>Meche Bot</h3>
        <div id="chat-messages">
            <!-- Existing messages should appear here -->
            {% for message in messages %}
                <div class="{% if message.username == 'AI' %}chat-message-ai{% else %}chat-message-user{% endif %}"><p class="chat-text">{{ message.username }}: {{ message.message }}</p></div>
            {% endfor %}
            <!-- Placeholder/Test if chat bot isn't working -->
            <!-- <div class="chat-message-user">
                <p class="chat-text">
                    Lorem ipsum dolor sit amet. Ea quidem vero est officiis omnis hic omnis voluptate quo rerum commodi et quos nihil et adipisci atque. Ut tenetur dolores ab eius veritatis qui voluptas accusamus rem odit labore eum officiis iusto est cupiditate modi.
                    Aut autem dolorum qui atque eveniet eum nemo odit id porro facilis aut sunt dignissimos sed voluptas dolore et laboriosam dolor. Ea officiis nemo sit pariatur vitae et voluptas velit eos Quis deleniti aut voluptas enim ut autem veniam. Quo maxime quam et atque consequatur et quia quam. Et tempora amet in consequatur reiciendis
                </p>
            </div>
            <div class="chat-message-ai">
                <p class="chat-text">Lorem ipsum dolor sit amet</p>
            </div>
            <div class="chat-message-user">
                <p class="chat-text">
                    Lorem ipsum dolor sit amet. Ea quidem vero est officiis omnis hic omnis voluptate quo rerum commodi et quos nihil et adipisci atque. Ut tenetur dolores ab eius veritatis qui voluptas accusamus rem odit labore eum officiis iusto est cupiditate modi.
                    Aut autem dolorum qui atque eveniet eum nemo odit id porro facilis aut sunt dignissimos sed voluptas dolore et laboriosam dolor. Ea officiis nemo sit pariatur vitae et voluptas velit eos Quis deleniti aut voluptas enim ut autem veniam. Quo maxime quam et atque consequatur et quia quam. Et tempora amet in consequatur reiciendis
                </p>
            </div>
            <div class="chat-message-ai">
                <p class="chat-text">
                    Lorem ipsum dolor sit amet. Ea quidem vero est officiis omnis hic omnis voluptate quo rerum commodi et quos nihil et adipisci atque. Ut tenetur dolores ab eius veritatis qui voluptas accusamus rem odit labore eum officiis iusto est cupiditate modi.
                    Aut autem dolorum qui atque eveniet eum nemo odit id porro facilis aut sunt dignissimos sed voluptas dolore et laboriosam dolor. Ea officiis nemo sit pariatur vitae et voluptas velit eos Quis deleniti aut voluptas enim ut autem veniam. Quo maxime quam et atque consequatur et quia quam. Et tempora amet in consequatur reiciendis
                </p>
            </div> -->
            <!-- PLACEHOLDER ENDS HERE -->
        </div>
    </div>
    <form method="POST" id="chat-form">
        {{ form.hidden_tag() }}
        {{ form.message.label }}{{ form.message() }}
        {{ form.send() }}
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>

<script>

function addTypingIndicator() {
    if (!document.getElementById("typing-indicator")) {
        const typingDiv = document.createElement("div");
        typingDiv.id = "typing-indicator";
        typingDiv.className = "chat-message-ai typing-indicator";

        const dotsParagaph = document.createElement("p");
        dotsParagaph.className = "typing-dots";

        for (let i = 0; i < 3; i++) {
            const dot = document.createElement("span");
            dotsParagaph.appendChild(dot);
        }

        typingDiv.appendChild(dotsParagaph);

        const chatBox = document.getElementById("chat-messages");
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

function removeTypingIndicator() {
    const typingDiv = document.getElementById("typing-indicator");
    if (typingDiv) {
        typingDiv.remove();
    }
}

$(document).ready(function() {
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var chatForm = $('#chat-form');
    var chatBox = $('#chat-messages');
    var messageInput = $('input[name="message"]');

    function scrollChatToBottom() {
        chatBox.scrollTop(chatBox[0].scrollHeight);
    }

    function addMessageToChat(username, message, timestamp) {
        var messageClass = $('<div>').addClass(
            username === 'AI' ? 'chat-message-ai' : 'chat-message-user'
        )
        var newMessage = $('<p>').addClass('chat-text').text(username + " (" + timestamp + "): " + message);
        
        messageClass.append(newMessage);
        chatBox.append(messageClass);
        scrollChatToBottom();
    }

    chatForm.on('submit', function(e) {
        e.preventDefault();
        var msg = messageInput.val().trim();
        if (msg === "") {
            return false;
        }
        
        // Clear input immediately
        messageInput.val('');
        
        // Add user message to chat
        addMessageToChat('You', msg, new Date().toLocaleTimeString());

        addTypingIndicator();

        $.ajax({
            url: "{{ url_for('get_ai_response') }}",
            method: "POST",
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({message: msg}),
            headers: {
                'X-CSRFToken': "{{ csrf_token() }}"
            },
            success: function(data) {
                removeTypingIndicator();
                if (data.error) {
                    console.log('AI responded with error:', data.error);
                    addMessageToChat('System', 'Error: ' + data.error, new Date().toLocaleTimeString());
                } else {
                    addMessageToChat('AI', data.ai_response, new Date().toLocaleTimeString());
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                removeTypingIndicator();
                console.log('Error:', textStatus, errorThrown);
                addMessageToChat('System', 'Error: Unable to get AI response', new Date().toLocaleTimeString());
            }
        });
        return false;
    });

    socket.on('message', function(msg) {
        addMessageToChat(msg.username, msg.message, msg.timestamp);
    });
});
</script>
{% endblock %}